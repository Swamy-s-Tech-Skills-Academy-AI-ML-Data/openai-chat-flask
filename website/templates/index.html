{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% block content %}
<div class="max-w-8xl mx-auto bg-white p-6 rounded-lg shadow">

    <h2 class="text-4xl font-semibold mb-4">Chat with Azure OpenAI ðŸ¤–</h2>

    <!-- Chat Box -->
    <div id="chat-box"
        class="bg-gray-50 h-96 overflow-y-auto p-4 rounded mb-4 border border-gray-600 flex flex-col space-y-2"></div>

    <!-- Input & Button -->
    <div class="flex space-x-2">
        <input id="user-input" type="text" placeholder="Type your message..."
            class="flex-grow border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-300" />
        <button id="send-btn"
            class="bg-blue-600 text-white font-semibold px-4 py-2 rounded hover:bg-blue-700 transition">
            Send
        </button>
    </div>
</div>

<script>
    const chatBox = document.getElementById("chat-box");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");

    function appendMessage(role, message) {
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("flex", "mb-2");

        if (role === "user") {
            // User message (align right, blue background)
            msgDiv.classList.add("justify-end");
            msgDiv.innerHTML = `
                <div class="bg-blue-600 text-white p-3 rounded-lg shadow max-w-lg rounded-br-none">
                    <strong>You:</strong> ${message}
                </div>
            `;
        } else {
            // Bot message (align left, gray background)
            msgDiv.classList.add("justify-start");
            msgDiv.innerHTML = `
                <div class="bg-gray-700 text-white p-3 rounded-lg shadow max-w-lg rounded-bl-none">
                    <strong>Bot:</strong> ${message}
                </div>
            `;
        }

        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll to the latest message
    }

    async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        appendMessage("user", message);
        userInput.value = "";
        userInput.focus(); // Keep input field focused after sending

        try {
            const res = await fetch("/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message })
            });
            const data = await res.json();
            if (data.response) {
                appendMessage("bot", data.response);
            } else if (data.error) {
                appendMessage("bot", `Error: ${data.error}`);
            }
        } catch (error) {
            appendMessage("bot", `Error: ${error}`);
        }
    }

    // Event listeners
    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", (event) => {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    });
</script>
{% endblock %}